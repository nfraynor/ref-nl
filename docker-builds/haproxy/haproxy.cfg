global
log stdout format raw local0
maxconn 5000
# Enable admin socket (optional; handy for live cert updates / debugging)
stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
daemon

defaults
log     global
mode    http
option  httplog
option  dontlognull
timeout connect 5s
timeout client  60s
timeout server  60s
option  http-keep-alive
retries 3

# Frontend on :80 — redirect to HTTPS except for ACME challenge files
frontend fe_http
bind *:80
http-request set-header X-Forwarded-Proto http
# Route ACME challenges to the acme-web backend
acl acme_challenge path_beg /.well-known/acme-challenge/
use_backend be_acme if acme_challenge
http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
redirect scheme https code 301 if !acme_challenge

# Frontend on :443 — TLS termination
frontend fe_https
# HAProxy expects PEM = fullchain + private key concatenated
bind *:443 ssl crt /etc/haproxy/certs/rugbyref.eu.pem alpn h2,http/1.1
http-request set-header X-Forwarded-Proto https
default_backend be_app

# Backend to apache container
backend be_app
option httpchk GET /healthz
http-check expect status 200
server app apache:80 check

# Backend serving ACME HTTP-01 challenge files
backend be_acme
server acme acme-web:80 check

# (optional) stats page
listen stats
bind *:8404
stats enable
stats uri /stats
stats refresh 10s
stats auth admin:changeme
