global
log stdout format raw local0
maxconn 5000
stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
daemon

defaults
log     global
mode    http
option  httplog
option  dontlognull
timeout connect 5s
timeout client  60s
timeout server  60s
option  http-keep-alive
retries 3

# :80 — serve ACME over HTTP, redirect everything else to HTTPS
frontend fe_http
bind *:80
http-request set-header X-Forwarded-Proto http
acl acme_challenge path_beg /.well-known/acme-challenge/
use_backend be_app if acme_challenge
redirect scheme https code 301

# :443 — terminate TLS and forward to apache
frontend fe_https
bind *:443 ssl crt /etc/haproxy/certs/rugbyref.eu.pem alpn h2,http/1.1
http-request set-header X-Forwarded-Proto https
http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
default_backend be_app

backend be_app
option httpchk GET /healthz
http-check expect status 200
server app apache:80 check

# (optional) stats
listen stats
bind *:8404
stats enable
stats uri /stats
stats refresh 10s
stats auth admin:changeme
